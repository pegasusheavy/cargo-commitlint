#!/bin/sh
# Commit-msg hook for cargo-commitlint
# Validates commit messages using this project's own cargo-commitlint binary

set -e

COMMIT_MSG_FILE="$1"

# Find the git repository root
GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo ".")
cd "$GIT_ROOT"

# Determine which binary to use (prefer release, fallback to debug)
if [ -f "./target/release/cargo-commitlint" ]; then
    CARGO_COMMITLINT="./target/release/cargo-commitlint"
elif [ -f "./target/debug/cargo-commitlint" ]; then
    CARGO_COMMITLINT="./target/debug/cargo-commitlint"
else
    # Build the project if binary doesn't exist
    echo "üî® Building cargo-commitlint..."
    if cargo build --release 2>/dev/null; then
        CARGO_COMMITLINT="./target/release/cargo-commitlint"
    elif cargo build 2>/dev/null; then
        CARGO_COMMITLINT="./target/debug/cargo-commitlint"
    else
        echo "‚ùå Failed to build cargo-commitlint. Skipping commit message validation."
        exit 0
    fi
fi

# Validate commit message using this project's binary
# Try cargo commitlint first (if installed), then fall back to direct binary
echo "üìù Validating commit message with cargo commitlint..."
if command -v cargo >/dev/null 2>&1 && cargo commitlint --version >/dev/null 2>&1; then
    # Use cargo commitlint subcommand if available
    if ! cat "$COMMIT_MSG_FILE" | cargo commitlint check; then
        echo "‚ùå Commit message validation failed."
        echo "   Please follow Conventional Commits specification."
        exit 1
    fi
elif [ -n "$CARGO_COMMITLINT" ]; then
    # Fall back to direct binary
    if ! cat "$COMMIT_MSG_FILE" | "$CARGO_COMMITLINT" check; then
        echo "‚ùå Commit message validation failed."
        echo "   Please follow Conventional Commits specification."
        exit 1
    fi
else
    echo "‚ö†Ô∏è  cargo-commitlint not found. Skipping validation."
    exit 0
fi

echo "‚úÖ Commit message is valid!"
exit 0

