#!/bin/sh
# Commit-msg hook for cargo-commitlint
# Validates commit messages using this project's own cargo-commitlint binary

set -e

COMMIT_MSG_FILE="$1"

# Find the git repository root
GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo ".")
cd "$GIT_ROOT"

# Determine which binary to use (prefer release, fallback to debug)
if [ -f "./target/release/cargo-commitlint" ]; then
    CARGO_COMMITLINT="./target/release/cargo-commitlint"
elif [ -f "./target/debug/cargo-commitlint" ]; then
    CARGO_COMMITLINT="./target/debug/cargo-commitlint"
else
    # Build the project if binary doesn't exist
    echo "ğŸ”¨ Building cargo-commitlint..."
    if cargo build --release 2>/dev/null; then
        CARGO_COMMITLINT="./target/release/cargo-commitlint"
    elif cargo build 2>/dev/null; then
        CARGO_COMMITLINT="./target/debug/cargo-commitlint"
    else
        echo "âŒ Failed to build cargo-commitlint. Skipping commit message validation."
        exit 0
    fi
fi

# Validate commit message using this project's binary
echo "ğŸ“ Validating commit message with cargo-commitlint..."
if ! cat "$COMMIT_MSG_FILE" | "$CARGO_COMMITLINT" check; then
    echo "âŒ Commit message validation failed."
    echo "   Please follow Conventional Commits specification."
    exit 1
fi

echo "âœ… Commit message is valid!"
exit 0

